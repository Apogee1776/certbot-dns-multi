name: Test the certbot-dns-multi snap

on:
  workflow_dispatch:
  schedule:
    - cron: '23 04 * * *' # At 04:23am every day

jobs:
  build:
    name: Test
    runs-on: "ubuntu-latest"
    steps:
      - name: Install snap
        run: |
          sudo apt-get update && \
          sudo apt-get -y install snapd && \
          sleep 5 && \
          sudo snap install core
      - name: Install Certbot snap
        run: |
          sudo snap install --classic certbot
      - name: Install certbot-dns-multi
        run: |
          sudo snap install --edge certbot-dns-multi
          sudo snap set certbot trust-plugin-with-root=ok
          sudo snap connect certbot:plugin certbot-dns-multi
      - name: Write the dns-multi credentials file
        env:
          TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
        run: |
          sudo -E sh -c 'umask 022; \
            echo -e "dns_multi_provider=cloudflare\nCLOUDFLARE_DNS_API_TOKEN=$TOKEN" \
            > /etc/letsencrypt/dns-multi.ini; \
            chmod 0600 /etc/letsencrypt/dns-multi.ini'
      - name: Issue a staging certificate
        run: |
          sudo certbot --staging register -n
          sudo certbot certonly --staging \
            -d "*.zorin.au" -a dns-multi \
            --dns-multi-credentials=/etc/letsencrypt/dns-multi.ini
          sudo certbot --staging unregister -n
